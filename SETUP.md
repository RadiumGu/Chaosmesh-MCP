# Chaos Mesh MCP Setup Guide

This guide will help you set up the Chaos Mesh MCP server from scratch.

## Prerequisites

Before starting, ensure you have:

- Python 3.10+
- kubectl configured for your EKS cluster
- AWS CLI configured
- Helm (for Chaos Mesh installation)
- Access to an EKS cluster with appropriate permissions

## Step-by-Step Setup

### 1. Clone and Navigate to Directory

```bash
git clone <your-repo-url>
cd Chaosmesh-MCP
```

### 2. Install Dependencies

```bash
# Install uv if not already installed
pip install uv

# Install project dependencies
uv sync
```

### 3. Configure EKS Access

Make sure your kubectl is configured to access your EKS cluster:

```bash
# Update kubeconfig for your EKS cluster
aws eks update-kubeconfig --region <your-region> --name <your-cluster-name>

# Verify connection
kubectl cluster-info
```

### 4. Run Setup Script

The setup script will:
- Install Chaos Mesh (if not present)
- Create necessary RBAC permissions
- Generate a service account kubeconfig file
- Verify the setup

```bash
# Make the script executable
chmod +x setup-eks-permissions.sh

# Run the setup script
./setup-eks-permissions.sh
```

**Important**: The setup script will create a file called `chaos-mesh-mcp-kubeconfig` in the current directory. This file contains sensitive authentication information and is automatically excluded from git via `.gitignore`.

### 5. Verify Setup

After running the setup script, you should see:

```
✓ Required tools are available
✓ Connected to cluster: <your-cluster>
✓ Chaos Mesh namespace exists
✓ Found X running Chaos Mesh controllers
✓ RBAC configuration applied
✓ Pod read permissions OK
✓ Chaos Mesh CRD permissions OK
✓ Permissions verified successfully
✓ Kubeconfig generated at ./chaos-mesh-mcp-kubeconfig
```

### 6. Start the MCP Server

```bash
# Start the server using the generated kubeconfig
uv run python server.py --kubeconfig ./chaos-mesh-mcp-kubeconfig
```

### 7. Test the Setup

You can test the setup by running a simple health check:

```bash
# In another terminal, you can test the MCP tools
# The server should be running and responding to MCP requests
```

## File Structure After Setup

After successful setup, your directory should contain:

```
Chaosmesh-MCP/
├── server.py
├── setup-eks-permissions.sh
├── rbac-config.yaml
├── chaos-mesh-mcp-kubeconfig  # ← Generated by setup script
├── README.md
├── SETUP.md
└── ...
```

## Troubleshooting

### Missing kubeconfig File

If you don't see the `chaos-mesh-mcp-kubeconfig` file after running the setup script:

1. Check if the setup script completed successfully
2. Look for any error messages in the script output
3. Verify your EKS cluster access permissions
4. Re-run the setup script: `./setup-eks-permissions.sh`

### Permission Issues

If you encounter permission errors:

1. Ensure your AWS credentials have sufficient EKS permissions
2. Check that kubectl can access your cluster
3. Verify the RBAC configuration was applied correctly:
   ```bash
   kubectl get serviceaccount chaos-mesh-mcp -n default
   kubectl get clusterrole chaos-mesh-mcp-role
   kubectl get clusterrolebinding chaos-mesh-mcp-binding
   ```

### Chaos Mesh Installation Issues

If Chaos Mesh installation fails:

1. Check if Helm is properly installed
2. Verify cluster has sufficient resources
3. Check Chaos Mesh controller logs:
   ```bash
   kubectl logs -n chaos-mesh -l app.kubernetes.io/name=chaos-mesh
   ```

## Security Notes

- The `chaos-mesh-mcp-kubeconfig` file contains sensitive authentication tokens
- This file is automatically excluded from git via `.gitignore`
- The service account has minimal required permissions for Chaos Mesh operations
- Tokens are generated with a long expiration (1 year) but can be regenerated if needed

## Regenerating Kubeconfig

If you need to regenerate the kubeconfig file:

```bash
# Simply re-run the setup script
./setup-eks-permissions.sh
```

The script is idempotent and can be run multiple times safely.
